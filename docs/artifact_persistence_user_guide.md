# Artifact Persistence User Guide

**Version:** 1.0
**Date:** November 17, 2025
**Status:** Active

---

## Overview

ASP agents automatically persist all artifacts (plans, designs, code, reviews) to the filesystem in both machine-readable (JSON) and human-readable (Markdown) formats. All artifacts are automatically committed to git for full version control and traceability.

**Key Benefits:**
- Open artifacts in your IDE for review
- Full git history of all agent decisions
- Human-readable markdown summaries
- Traceability from requirements to code
- CI/CD integration ready

---

## Quick Start

### Automatic Persistence (Default)

All agents automatically write artifacts when you run them:

```python
from asp.agents import PlanningAgent
from asp.models import TaskRequirements

# Create agent
agent = PlanningAgent()

# Execute (artifacts written automatically)
requirements = TaskRequirements(
    task_id="JWT-AUTH-001",
    description="Implement JWT authentication",
    requirements="..."
)
plan = agent.execute(requirements)

# Artifacts created:
# - artifacts/JWT-AUTH-001/plan.json
# - artifacts/JWT-AUTH-001/plan.md
# - Git commit: "Planning Agent: Add project plan for JWT-AUTH-001"
```

### What Gets Created

After running agents, you'll find:

```
your-project/
├── artifacts/
│   └── JWT-AUTH-001/
│       ├── plan.json              # Machine-readable ProjectPlan
│       ├── plan.md                # Human-readable summary
│       ├── design.json            # DesignSpecification
│       ├── design.md              # Design summary
│       ├── design_review.json    # DesignReviewReport
│       ├── design_review.md      # Review report
│       ├── code_manifest.json    # GeneratedCode metadata
│       └── code_review.json      # CodeReviewReport (future)
├── src/
│   └── api/
│       └── auth.py                # Actual generated code
└── tests/
    └── test_auth.py              # Actual generated tests
```

---

## Directory Structure

### Artifacts Directory

All agent outputs are stored in `artifacts/{task_id}/`:

| File | Format | Purpose |
|------|--------|---------|
| `plan.json` | JSON | Full ProjectPlan model (machine-readable) |
| `plan.md` | Markdown | Human-readable plan summary |
| `design.json` | JSON | Full DesignSpecification model |
| `design.md` | Markdown | Human-readable design summary |
| `design_review.json` | JSON | Full DesignReviewReport model |
| `design_review.md` | Markdown | Human-readable review report |
| `code_manifest.json` | JSON | GeneratedCode metadata |
| `code_review.json` | JSON | CodeReviewReport (when implemented) |

### Generated Code

Actual code is written to standard directories:

| Directory | Contents |
|-----------|----------|
| `src/` | Generated source code |
| `tests/` | Generated test files |
| `docs/` | Generated documentation (optional) |
| `config/` | Configuration files (optional) |

---

## Git Integration

### Automatic Commits

Every agent execution creates a git commit:

```bash
# After Planning Agent
git log --oneline -1
# c0cd299 Planning Agent: Add project plan for JWT-AUTH-001

# After Design Agent
git log --oneline -1
# a1b2c3d Design Agent: Add design specification for JWT-AUTH-001

# After Code Agent
git log --oneline -1
# d4e5f6g Code Agent: Implement JWT-AUTH-001 - JWT authentication endpoints
```

### Commit Message Format

```
{Agent Name}: {Action} for {task_id} [{status}]

 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

Examples:
- `Planning Agent: Add project plan for JWT-AUTH-001`
- `Design Review Agent: Add design review for JWT-AUTH-001 [PASS]`
- `Code Review Agent: Add code review for JWT-AUTH-001 [FAIL - 2 Critical]`

### Viewing Git History

```bash
# View all agent commits for a task
git log --grep="JWT-AUTH-001"

# View all Planning Agent commits
git log --grep="Planning Agent"

# View all failed reviews
git log --grep="FAIL"

# View changes to artifacts
git show HEAD:artifacts/JWT-AUTH-001/plan.md
```

---

## Markdown Format Examples

### plan.md

```markdown
# Project Plan: JWT-AUTH-001

**Task:** Implement JWT authentication for FastAPI application
**Estimated Effort:** 8 hours
**Estimated Cost:** $0.50

## Task Decomposition

### SU-001: JWT Token Generation
- **Semantic Complexity:** 3.2
- **Dependencies:** None
- **Type:** API Endpoint

### SU-002: JWT Token Validation
- **Semantic Complexity:** 2.8
- **Dependencies:** SU-001
- **Type:** Middleware

## PROBE-AI Cost Prediction
- **Estimated Latency:** 45 seconds
- **Estimated Total Cost:** $0.50
- **Confidence:** 85%

---
*Generated by Planning Agent v1.0.0 on 2025-11-17T14:30:00*
```

### design_review.md

```markdown
# Design Review Report: JWT-AUTH-001

**Review Status:** FAIL
**Reviewed by:** Design Review Agent v1.0.0
**Date:** 2025-11-17T14:45:00

## Summary
- **Total Issues:** 3
- **Critical:** 1
- **High:** 2

## Critical Issues

### ISSUE-001: Password stored in plaintext
**Category:** Security
**Severity:** Critical
**Affected Phase:** Design
**Evidence:** users table, password column (VARCHAR)

User credentials vulnerable to breach; violates security best practices.

**Recommendation:** Use bcrypt for password hashing. Store hash in password_hash column.

## Phase-Aware Issue Breakdown
- **Planning Phase Issues:** 0
- **Design Phase Issues:** 3
```

---

## Using the Utilities Directly

### artifact_io Module

```python
from asp.utils.artifact_io import (
    write_artifact_json,
    write_artifact_markdown,
    read_artifact_json,
    ensure_artifact_directory,
    write_generated_file,
)

# Write JSON artifact
write_artifact_json(
    task_id="JWT-AUTH-001",
    artifact_type="plan",
    data=project_plan
)

# Write Markdown artifact
write_artifact_markdown(
    task_id="JWT-AUTH-001",
    artifact_type="plan",
    markdown_content="# Project Plan\n..."
)

# Read JSON artifact
data = read_artifact_json(
    task_id="JWT-AUTH-001",
    artifact_type="plan"
)

# Write generated code file
write_generated_file(
    file_path="src/api/auth.py",
    content="from fastapi import APIRouter\n..."
)
```

### git_utils Module

```python
from asp.utils.git_utils import (
    git_commit_artifact,
    is_git_repository,
    git_status_check,
)

# Check if in git repo
if is_git_repository():
    # Commit artifacts
    commit_hash = git_commit_artifact(
        task_id="JWT-AUTH-001",
        agent_name="Planning Agent",
        artifact_files=["artifacts/JWT-AUTH-001/plan.json", "artifacts/JWT-AUTH-001/plan.md"]
    )
    print(f"Committed: {commit_hash}")
```

### markdown_renderer Module

```python
from asp.utils.markdown_renderer import (
    render_plan_markdown,
    render_design_markdown,
    render_design_review_markdown,
)

# Render plan as markdown
markdown = render_plan_markdown(project_plan)
print(markdown)  # Human-readable markdown string
```

---

## Workflow Examples

### Example 1: Full Pipeline

```python
from asp.agents import PlanningAgent, DesignAgent, DesignReviewAgent, CodeAgent

# 1. Planning
planning_agent = PlanningAgent()
plan = planning_agent.execute(requirements)
# Creates: artifacts/JWT-AUTH-001/plan.json, plan.md
# Commits: "Planning Agent: Add project plan for JWT-AUTH-001"

# 2. Design
design_agent = DesignAgent()
design = design_agent.execute(plan)
# Creates: artifacts/JWT-AUTH-001/design.json, design.md
# Commits: "Design Agent: Add design specification for JWT-AUTH-001"

# 3. Design Review
review_agent = DesignReviewAgent()
review = review_agent.execute(design)
# Creates: artifacts/JWT-AUTH-001/design_review.json, design_review.md
# Commits: "Design Review Agent: Add design review for JWT-AUTH-001 [PASS]"

# 4. Code Generation
code_agent = CodeAgent()
code = code_agent.execute(design, review)
# Creates: src/api/auth.py, tests/test_auth.py, artifacts/JWT-AUTH-001/code_manifest.json
# Commits: "Code Agent: Implement JWT-AUTH-001 - JWT authentication endpoints"

# Result: Full git history + all artifacts in IDE
```

### Example 2: Inspecting Artifacts

```bash
# Open plan in your IDE
code artifacts/JWT-AUTH-001/plan.md

# View design in terminal
cat artifacts/JWT-AUTH-001/design.md

# Search all reviews
grep -r "Critical" artifacts/*/design_review.md

# Find all failed reviews
grep -r "FAIL" artifacts/*/*.md
```

### Example 3: Diffing Versions

```bash
# View changes to plan (if replanned)
git diff HEAD~1 artifacts/JWT-AUTH-001/plan.md

# Compare two versions
git show abc1234:artifacts/JWT-AUTH-001/design.md
git show def5678:artifacts/JWT-AUTH-001/design.md
```

---

## Configuration

### Disabling Persistence (Testing)

Currently, persistence is always enabled. To disable for testing, you can:

```python
# Option 1: Mock the utilities (in tests)
from unittest.mock import patch

with patch('asp.agents.planning_agent.write_artifact_json'):
    with patch('asp.agents.planning_agent.git_commit_artifact'):
        plan = agent.execute(requirements)  # No artifacts written
```

### Custom Base Path

```python
from asp.utils.artifact_io import write_artifact_json

# Write to custom location
write_artifact_json(
    task_id="JWT-AUTH-001",
    artifact_type="plan",
    data=plan,
    base_path="/custom/path"  # Creates /custom/path/artifacts/JWT-AUTH-001/
)
```

---

## Troubleshooting

### Issue: Artifacts not being created

**Check:**
1. Is the current directory writable?
   ```bash
   touch test_file && rm test_file  # Test write permissions
   ```

2. Check logs for errors:
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   # Re-run agent to see detailed logs
   ```

3. Verify utilities imported:
   ```python
   from asp.utils import artifact_io, git_utils, markdown_renderer
   print("Utilities loaded successfully")
   ```

### Issue: Git commits not being created

**Check:**
1. Are you in a git repository?
   ```bash
   git status  # Should show current branch
   ```

2. Is git installed?
   ```bash
   git --version  # Should show version
   ```

3. Check git user config:
   ```bash
   git config user.name
   git config user.email
   ```

### Issue: Permission denied when writing files

**Solution:**
```bash
# Check directory permissions
ls -la artifacts/

# Create artifacts directory manually
mkdir -p artifacts

# Set permissions
chmod 755 artifacts
```

---

## Best Practices

### 1. Review Before Accepting

Always review artifacts before accepting agent outputs:

```bash
# After Planning Agent
cat artifacts/JWT-AUTH-001/plan.md

# If plan looks good, continue to Design Agent
# If not, provide feedback or rerun
```

### 2. Use Git Branches for Experiments

```bash
# Create branch for agent experiments
git checkout -b agent-jwt-auth

# Let agents work
python run_agents.py

# Review artifacts
git diff main

# If good, merge
git checkout main
git merge agent-jwt-auth

# If bad, discard
git checkout main
git branch -D agent-jwt-auth
```

### 3. Archive Old Tasks

```bash
# Move completed tasks to archive branch
git checkout -b archive-2025-11
git mv artifacts/JWT-AUTH-001 archived/2025-11/
git commit -m "Archive JWT-AUTH-001"
git checkout main
```

### 4. Search Across All Tasks

```bash
# Find all security issues
grep -r "Security" artifacts/*/design_review.md

# Find all failed reviews
grep -r "FAIL" artifacts/*/*.md

# Find all Critical issues
grep -r "Critical" artifacts/*/*.json
```

---

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: ASP Agent Pipeline

on:
  push:
    paths:
      - 'artifacts/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for failed reviews
        run: |
          if grep -r "FAIL" artifacts/*/review.md; then
            echo "Failed reviews detected"
            exit 1
          fi

      - name: Run linters on generated code
        run: |
          ruff check src/
          mypy src/
```

---

## Related Documentation

- [Artifact Persistence ADR](artifact_persistence_version_control_decision.md) - Architecture decision
- [Telemetry User Guide](telemetry_user_guide.md) - Cost tracking and observability
- [Phase-Aware Feedback](error_correction_feedback_loops_decision.md) - Error correction

---

## API Reference

### artifact_io Module

#### write_artifact_json(task_id, artifact_type, data, base_path=None) → Path
Write artifact data as JSON file.

#### write_artifact_markdown(task_id, artifact_type, markdown_content, base_path=None) → Path
Write artifact data as Markdown file.

#### read_artifact_json(task_id, artifact_type, base_path=None) → dict
Read artifact data from JSON file.

#### write_generated_file(file_path, content, base_path=None) → Path
Write a generated code file to disk.

#### artifact_exists(task_id, artifact_type, format='json', base_path=None) → bool
Check if an artifact file exists.

### git_utils Module

#### git_commit_artifact(task_id, agent_name, artifact_files, status=None, path=None) → str
Commit artifact files with standardized message format.

#### is_git_repository(path=None) → bool
Check if the current directory is a git repository.

#### git_status_check(path=None) → tuple[bool, str]
Check git working directory status.

### markdown_renderer Module

#### render_plan_markdown(plan: ProjectPlan) → str
Render ProjectPlan as human-readable Markdown.

#### render_design_markdown(design: DesignSpecification) → str
Render DesignSpecification as human-readable Markdown.

#### render_design_review_markdown(review: DesignReviewReport) → str
Render DesignReviewReport as human-readable Markdown.

---

**Last Updated:** November 17, 2025
**Version:** 1.0
