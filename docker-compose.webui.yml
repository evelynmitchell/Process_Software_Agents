# ASP Platform - Docker Compose
# Run with: docker compose -f docker-compose.webui.yml up
#
# Services:
#   asp-webui        - Web UI dashboard (port 8000)
#   asp-webui-dev    - Web UI with live reload (port 8001, profile: dev)
#   asp-agent-runner - Agent execution container (profile: agents)

services:
  # ASP Web UI Service
  asp-webui:
    build:
      context: .
      dockerfile: Dockerfile.webui
    container_name: asp-webui
    ports:
      - "8000:8000"
    volumes:
      # Mount data directory for telemetry database persistence
      - ./data:/app/data
      # Optional: Mount src for development (live reload)
      # - ./src:/app/src
    environment:
      - PYTHONPATH=/app
      - ASP_USER_ID=admin@asp-platform.local
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Development mode with live reload
  asp-webui-dev:
    build:
      context: .
      dockerfile: Dockerfile.webui
    container_name: asp-webui-dev
    ports:
      - "8001:8000"
    volumes:
      # Mount source code for live development
      - ./src:/app/src:ro
      - ./data:/app/data
    environment:
      - PYTHONPATH=/app
      - ASP_USER_ID=developer@asp-platform.local
    command: uvicorn src.asp.web.main:app --host 0.0.0.0 --port 8000 --reload
    profiles:
      - dev

  # ASP Agent Runner - Executes agent pipelines on tasks
  # Run with: docker compose -f docker-compose.webui.yml --profile agents run asp-agent-runner
  asp-agent-runner:
    build:
      context: .
      dockerfile: Dockerfile.agents
    container_name: asp-agent-runner
    volumes:
      # Shared data directory (database, telemetry)
      - ./data:/app/data
      # Artifacts output directory
      - ./artifacts:/app/artifacts
      # Target repository to work on (mount your project here)
      - ${ASP_WORKSPACE:-./workspace}:/workspace
    environment:
      - PYTHONPATH=/app
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      - ASP_USER_ID=${ASP_USER_ID:-agent@asp-platform.local}
    working_dir: /app
    stdin_open: true
    tty: true
    profiles:
      - agents
