# Session 20251120.6 - Multi-Stage Code Generation Implementation

**Date:** November 20, 2025
**Session ID:** 20251120.6
**Branch:** main

## Objective

Implement Option 2 (Multi-Stage Code Generation) from the Architecture Decision Record created in Session 5 to fix Code Agent JSON parsing failures and improve E2E test success rate from 50% to >95%.

## Background

Session 5 (20251120.5) completed comprehensive analysis:
- Ran E2E tests: 50% success rate (2/4 tests passing)
- Root cause identified: Code Agent fails with `JSONDecodeError` due to unescaped characters in large JSON responses (20-50KB)
- Problem: LLMs struggle to maintain correct JSON escaping for embedded Python source code with docstrings, quotes, and special characters
- Solution selected: **Option 2 (Multi-Stage Generation)** - Generate file manifest first (small JSON), then generate individual file contents (raw code, no JSON)

## Session Goal

Implement multi-stage code generation architecture:
1. **Phase 1:** Manifest generation - LLM generates list of files with metadata (2-5KB JSON, no escaping issues)
2. **Phase 2:** File content generation - LLM generates each file separately as raw code (no JSON wrapping)
3. **Phase 3:** Orchestration - Coordinate both phases and assemble final result
4. **Phase 4:** Testing - Validate >95% E2E test success rate

**Estimated Time:** 4-6 hours
**Target:** >95% E2E test success rate (up from 50%)

## Current Status

**Repository State:**
- Branch: main
- Status: Clean, synchronized with remote
- Latest summary: session20251120.5.md (completed comprehensive diagnosis)

**Agent Status:**
- Planning Agent: ‚úÖ 100% operational
- Design Agent: ‚úÖ 100% operational
- Design Review Agent: ‚úÖ 100% operational
- Code Agent: ‚ö†Ô∏è 50% success rate (JSON parsing failures) - **FIX IN PROGRESS**
- Code Review Agent: ‚úÖ 100% implemented
- Test Agent: ‚úÖ 100% implemented
- Postmortem Agent: ‚úÖ 100% implemented

**E2E Test Results (Session 5):**
- `test_planning_agent_hello_world`: ‚úÖ PASS
- `test_design_agent_hello_world`: ‚úÖ PASS
- `test_code_agent_hello_world`: ‚ùå FAIL (JSONDecodeError)
- `test_complete_agent_pipeline_hello_world`: ‚ùå FAIL (blocked by Code Agent)

## Implementation Plan

### Phase 1: Manifest Generation (2-3 hours)

**Files to Create:**
- `src/asp/prompts/code_agent_v2_manifest.txt` - Prompt for generating file list with metadata
- `src/asp/models/code.py` - Add `FileManifest` and `FileMetadata` Pydantic models
- `tests/unit/test_agents/test_code_agent_multi_stage.py` - Unit tests for manifest generation

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Add `_generate_file_manifest()` method

**Tasks:**
1. Create manifest generation prompt
2. Implement `_generate_file_manifest()` method
3. Create Pydantic models for manifest structure
4. Write unit tests

### Phase 2: File Content Generation (1-2 hours)

**Files to Create:**
- `src/asp/prompts/code_agent_v2_file_generation.txt` - Prompt for generating single file content

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Add `_generate_file_content()` method

**Tasks:**
1. Create file generation prompt
2. Implement `_generate_file_content()` method (returns raw code)
3. Add retry logic for individual file failures
4. Write unit tests

### Phase 3: Orchestration & Integration (1-2 hours)

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Refactor `_generate_code()` to coordinate both phases

**Tasks:**
1. Refactor `_generate_code()` to coordinate manifest + file generation
2. Add file consistency validation
3. Update telemetry to track per-file costs
4. Implement feature flag for gradual rollout

### Phase 4: Testing & Validation (1 hour)

**Files to Modify:**
- `tests/e2e/test_all_agents_hello_world_e2e.py` - Verify tests pass

**Tasks:**
1. Run E2E tests 10+ times, measure success rate
2. Compare code quality (linting, test coverage)
3. Measure actual costs (target: <$3.00/task)
4. Update documentation

## Success Criteria

- [ ] E2E tests pass >95% of the time (currently ~50%)
- [ ] Generated code passes linting without changes
- [ ] Tests pass on first run (no manual fixes needed)
- [ ] Cost per task <$3.00 (acceptable range)
- [ ] Latency <120s (with parallel generation, target: <60s)
- [ ] Clear error messages for file generation failures
- [ ] Comprehensive test coverage for new methods

## Expected Benefits

1. **Reliability:** 50% ‚Üí >95% E2E test success rate
2. **Debuggability:** Per-file errors easier to diagnose than monolithic JSON parse failures
3. **Scalability:** Can handle larger projects (10-15 files) without reliability degradation
4. **Quality:** Smaller, focused LLM calls produce higher quality output
5. **Cost:** 2-4x cost increase acceptable for reliability improvement (~$1-2/task ‚Üí ~$2-3/task)

## Documentation References

- **Session 5 Summary:** `Summary/summary20261120.5.md` - Complete diagnosis and analysis
- **Debugging Doc:** `docs/debugging/code_agent_json_parsing_issue.md` - Technical deep dive (22.8KB)
- **ADR:** `docs/code_generation_artifact_format_decision.md` - Architecture Decision Record (28.7KB)

## Rollout Strategy

**Feature Flag Approach (Recommended):**
```python
USE_MULTI_STAGE = os.getenv("ASP_MULTI_STAGE_CODE_GEN", "false").lower() == "true"

def _generate_code(self, input_data: CodeInput) -> GeneratedCode:
    if USE_MULTI_STAGE:
        return self._generate_code_multi_stage(input_data)
    else:
        return self._generate_code_single_call(input_data)
```

- Week 1: Feature flag enabled, monitor 20+ runs
- Week 2: Make multi-stage default if success rate >95%
- Week 3: Remove legacy single-call implementation

## Activities Completed

[This section will be populated as work progresses]

## Session Metrics

[This section will be populated at session end]

## Files Created/Modified This Session

### Created
- `Summary/summary20251120.6.md` - This session summary

### Modified
[To be updated as work progresses]

## Key Learnings

[To be captured during implementation]

## Next Steps

[To be determined based on implementation results]

## Notes

- This is the 6th session on November 20, 2025
- Addresses critical blocker identified in Session 5
- Implementation follows detailed plan from ADR
- Focus on incremental testing and validation
- Monitor costs and reliability metrics closely

---

**Author:** Claude (ASP Development Assistant)
**Status:** üöß IN PROGRESS - Implementation beginning
**Previous Session:** 20251120.5 (Diagnosis and planning)
**Next Session:** TBD (Validation or next priority)
