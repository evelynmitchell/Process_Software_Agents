# Session 20251120.6 - Multi-Stage Code Generation Implementation

**Date:** November 20, 2025
**Session ID:** 20251120.6
**Branch:** main

## Objective

Implement Option 2 (Multi-Stage Code Generation) from the Architecture Decision Record created in Session 5 to fix Code Agent JSON parsing failures and improve E2E test success rate from 50% to >95%.

## Background

Session 5 (20251120.5) completed comprehensive analysis:
- Ran E2E tests: 50% success rate (2/4 tests passing)
- Root cause identified: Code Agent fails with `JSONDecodeError` due to unescaped characters in large JSON responses (20-50KB)
- Problem: LLMs struggle to maintain correct JSON escaping for embedded Python source code with docstrings, quotes, and special characters
- Solution selected: **Option 2 (Multi-Stage Generation)** - Generate file manifest first (small JSON), then generate individual file contents (raw code, no JSON)

## Session Goal

Implement multi-stage code generation architecture:
1. **Phase 1:** Manifest generation - LLM generates list of files with metadata (2-5KB JSON, no escaping issues)
2. **Phase 2:** File content generation - LLM generates each file separately as raw code (no JSON wrapping)
3. **Phase 3:** Orchestration - Coordinate both phases and assemble final result
4. **Phase 4:** Testing - Validate >95% E2E test success rate

**Estimated Time:** 4-6 hours
**Target:** >95% E2E test success rate (up from 50%)

## Current Status

**Repository State:**
- Branch: main
- Status: Clean, synchronized with remote
- Latest summary: session20251120.5.md (completed comprehensive diagnosis)

**Agent Status:**
- Planning Agent: ‚úÖ 100% operational
- Design Agent: ‚úÖ 100% operational
- Design Review Agent: ‚úÖ 100% operational
- Code Agent: ‚ö†Ô∏è 50% success rate (JSON parsing failures) - **FIX IN PROGRESS**
- Code Review Agent: ‚úÖ 100% implemented
- Test Agent: ‚úÖ 100% implemented
- Postmortem Agent: ‚úÖ 100% implemented

**E2E Test Results (Session 5):**
- `test_planning_agent_hello_world`: ‚úÖ PASS
- `test_design_agent_hello_world`: ‚úÖ PASS
- `test_code_agent_hello_world`: ‚ùå FAIL (JSONDecodeError)
- `test_complete_agent_pipeline_hello_world`: ‚ùå FAIL (blocked by Code Agent)

## Implementation Plan

### Phase 1: Manifest Generation (2-3 hours)

**Files to Create:**
- `src/asp/prompts/code_agent_v2_manifest.txt` - Prompt for generating file list with metadata
- `src/asp/models/code.py` - Add `FileManifest` and `FileMetadata` Pydantic models
- `tests/unit/test_agents/test_code_agent_multi_stage.py` - Unit tests for manifest generation

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Add `_generate_file_manifest()` method

**Tasks:**
1. Create manifest generation prompt
2. Implement `_generate_file_manifest()` method
3. Create Pydantic models for manifest structure
4. Write unit tests

### Phase 2: File Content Generation (1-2 hours)

**Files to Create:**
- `src/asp/prompts/code_agent_v2_file_generation.txt` - Prompt for generating single file content

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Add `_generate_file_content()` method

**Tasks:**
1. Create file generation prompt
2. Implement `_generate_file_content()` method (returns raw code)
3. Add retry logic for individual file failures
4. Write unit tests

### Phase 3: Orchestration & Integration (1-2 hours)

**Files to Modify:**
- `src/asp/agents/code_agent.py` - Refactor `_generate_code()` to coordinate both phases

**Tasks:**
1. Refactor `_generate_code()` to coordinate manifest + file generation
2. Add file consistency validation
3. Update telemetry to track per-file costs
4. Implement feature flag for gradual rollout

### Phase 4: Testing & Validation (1 hour)

**Files to Modify:**
- `tests/e2e/test_all_agents_hello_world_e2e.py` - Verify tests pass

**Tasks:**
1. Run E2E tests 10+ times, measure success rate
2. Compare code quality (linting, test coverage)
3. Measure actual costs (target: <$3.00/task)
4. Update documentation

## Success Criteria

- [ ] E2E tests pass >95% of the time (currently ~50%)
- [ ] Generated code passes linting without changes
- [ ] Tests pass on first run (no manual fixes needed)
- [ ] Cost per task <$3.00 (acceptable range)
- [ ] Latency <120s (with parallel generation, target: <60s)
- [ ] Clear error messages for file generation failures
- [ ] Comprehensive test coverage for new methods

## Expected Benefits

1. **Reliability:** 50% ‚Üí >95% E2E test success rate
2. **Debuggability:** Per-file errors easier to diagnose than monolithic JSON parse failures
3. **Scalability:** Can handle larger projects (10-15 files) without reliability degradation
4. **Quality:** Smaller, focused LLM calls produce higher quality output
5. **Cost:** 2-4x cost increase acceptable for reliability improvement (~$1-2/task ‚Üí ~$2-3/task)

## Documentation References

- **Session 5 Summary:** `Summary/summary20261120.5.md` - Complete diagnosis and analysis
- **Debugging Doc:** `docs/debugging/code_agent_json_parsing_issue.md` - Technical deep dive (22.8KB)
- **ADR:** `docs/code_generation_artifact_format_decision.md` - Architecture Decision Record (28.7KB)

## Rollout Strategy

**Feature Flag Approach (Recommended):**
```python
USE_MULTI_STAGE = os.getenv("ASP_MULTI_STAGE_CODE_GEN", "false").lower() == "true"

def _generate_code(self, input_data: CodeInput) -> GeneratedCode:
    if USE_MULTI_STAGE:
        return self._generate_code_multi_stage(input_data)
    else:
        return self._generate_code_single_call(input_data)
```

- Week 1: Feature flag enabled, monitor 20+ runs
- Week 2: Make multi-stage default if success rate >95%
- Week 3: Remove legacy single-call implementation

## Activities Completed

### Phase 1: Manifest Generation ‚úÖ COMPLETE (Elapsed: ~2 hours)

**1. Created manifest generation prompt**
- File: `src/asp/prompts/code_agent_v2_manifest.txt` (328 lines)
- Comprehensive instructions for generating file manifests
- Examples for Hello World and JWT Auth systems
- Quality checklist for validation
- Output: Small JSON (2-5KB) with no code content

**2. Created Pydantic models for manifest structure**
- File: `src/asp/models/code.py` (added FileMetadata and FileManifest models)
- FileMetadata: file_path, file_type, description, estimated_lines, dependencies
- FileManifest: task_id, files list, dependencies, setup_instructions, totals
- Full validation with min/max constraints

**3. Implemented _generate_file_manifest() method**
- File: `src/asp/agents/code_agent.py` (114 lines added)
- Loads manifest prompt template
- Calls LLM with lower token limit (4000 tokens for small JSON)
- Robust JSON parsing with markdown fence extraction
- Calculates totals if not provided by LLM
- Comprehensive error handling

**4. Created comprehensive unit test suite**
- File: `tests/unit/test_agents/test_code_agent_multi_stage.py` (448 lines)
- 10 unit tests, all passing ‚úÖ
- Tests cover:
  * Success path with valid manifest
  * Markdown fence extraction
  * Total calculation
  * Invalid JSON handling
  * Missing required fields
  * Prompt not found error
  * Metadata validation
  * Malformed JSON fence handling
  * Pydantic model validation

**Commit:** `fadda9e` - "Phase 1: Implement file manifest generation for multi-stage code gen"

### Phase 2: File Content Generation üöß IN PROGRESS (Elapsed: ~30 minutes)

**1. Created file content generation prompt ‚úÖ**
- File: `src/asp/prompts/code_agent_v2_file_generation.txt` (434 lines)
- Instructions for generating SINGLE file at a time
- Returns raw code content (no JSON, no markdown fences)
- Comprehensive guidelines for each file type:
  * Source files: Complete implementation, type hints, docstrings, error handling
  * Test files: Unit tests, edge cases, mocking
  * Config files: Environment templates, linter configs
  * Requirements files: Exact versions, grouping, comments
  * Documentation files: README with setup/running/troubleshooting
- Quality checklist for verification
- Examples:
  * main.py (FastAPI Hello World)
  * tests/test_main.py (comprehensive test suite)
  * requirements.txt (dependency management)
  * README.md (complete documentation)

**Commit:** `2b1b54b` - "Phase 2: Add file content generation prompt"

**2. Implemented _generate_file_content() method ‚úÖ**
- File: `src/asp/agents/code_agent.py` (_generate_file_content method, 118 lines)
- Generates ONE file at a time (no JSON wrapping)
- Returns raw code content (avoids escaping issues)
- Dynamic token limits based on estimated file size: `min(8000, max(2000, lines * 2))`
- Retry logic with max 3 attempts for robustness
- Strips markdown fences if present (defensive programming)
- Validates content is not empty (min 10 characters)
- Comprehensive logging for debugging

**Commit:** Part of commit `7160e7f` - "Phase 2 & 3: Implement file content generation and multi-stage orchestration"

### Phase 3: Orchestration & Integration ‚úÖ COMPLETE (Elapsed: ~1 hour)

**1. Implemented _generate_code_multi_stage() method ‚úÖ**
- File: `src/asp/agents/code_agent.py` (_generate_code_multi_stage method, 112 lines)
- Coordinates Phase 1 (manifest) + Phase 2 (file content)
- Generates files sequentially with progress logging
- Builds file_structure dict from generated files
- Calculates actual LOC by counting non-blank lines
- Extracts semantic units and components for traceability
- Assembles complete GeneratedCode object with all metadata

**2. Implemented feature flag for gradual rollout ‚úÖ**
- Added `use_multi_stage` parameter to CodeAgent.__init__()
- Priority: explicit parameter > env var > default (False)
- Updated `_generate_code()` to dispatch based on flag
- Renamed original method to `_generate_code_single_call()`
- Backward compatible with legacy mode

**3. Updated E2E tests ‚úÖ**
- Modified test to use `CodeAgent(use_multi_stage=True)`
- Explicit parameter instead of environment variable
- Cleaner and more testable approach

**Commits:**
- `7160e7f` - "Phase 2 & 3: Implement file content generation and multi-stage orchestration"
- `bd7b551` - "Add use_multi_stage parameter to CodeAgent constructor"

### Phase 4: Bug Fixes & Testing üöß IN PROGRESS (Elapsed: ~30 minutes)

**1. Fixed prompt template formatting issues ‚úÖ**
- Fixed curly brace escaping in code examples
- Fixed JSON escaping for design specification
- Applied to all three generation methods
- Issue: Python's `.format()` interprets `{` and `}` as template variables
- Solution: Escape all curly braces in JSON: `{{` and `}}`

**Commits:**
- `0cc12a8` - "Fix prompt template curly brace escaping for Python format()"
- `9768c96` - "Fix: Escape curly braces in design specification JSON"

**2. Run E2E tests and validate success rate** (In progress)
- Test command: `pytest tests/e2e/test_all_agents_hello_world_e2e.py::TestAllAgentsHelloWorldE2E::test_code_agent_hello_world`
- Using `use_multi_stage=True` flag
- Awaiting results...

## Session Metrics

### Time Investment (Estimated)
- Phase 1 (Manifest Generation): ~2 hours
- Phase 2 (File Content Generation): ~1.5 hours
- Phase 3 (Orchestration): ~1 hour
- Phase 4 (Bug Fixes): ~30 minutes
- **Total elapsed: ~5 hours**

### Code Written
- **New files created:** 3
  * `src/asp/prompts/code_agent_v2_manifest.txt` (328 lines)
  * `src/asp/prompts/code_agent_v2_file_generation.txt` (434 lines)
  * `tests/unit/test_agents/test_code_agent_multi_stage.py` (448 lines)
- **Files modified:** 3
  * `src/asp/models/code.py` (+129 lines for FileMetadata and FileManifest)
  * `src/asp/agents/code_agent.py` (+356 lines for multi-stage implementation)
  * `tests/e2e/test_all_agents_hello_world_e2e.py` (+2 lines for use_multi_stage flag)
- **Total lines added: ~1,697 lines**

### Git Activity
- **Commits:** 5
  * `fb01e31` - Session initialization
  * `fadda9e` - Phase 1 implementation
  * `2b1b54b` - Phase 2 prompt
  * `7160e7f` - Phase 2 & 3 implementation
  * `bd7b551` - Constructor parameter
  * `0cc12a8` - Curly brace fix
  * `9768c96` - JSON escaping fix
- **Branch:** main (ahead of origin by 7 commits)

### Testing
- **Unit tests created:** 10 (all passing ‚úÖ)
- **Test coverage:** Manifest generation fully tested
- **E2E tests:** Modified to use multi-stage mode
- **E2E test status:** Running...

## Files Created/Modified This Session

### Created
- `Summary/summary20251120.6.md` - This session summary

### Modified
[To be updated as work progresses]

## Key Learnings

[To be captured during implementation]

## Next Steps

[To be determined based on implementation results]

## Notes

- This is the 6th session on November 20, 2025
- Addresses critical blocker identified in Session 5
- Implementation follows detailed plan from ADR
- Focus on incremental testing and validation
- Monitor costs and reliability metrics closely

---

**Author:** Claude (ASP Development Assistant)
**Status:** üöß IN PROGRESS - Implementation beginning
**Previous Session:** 20251120.5 (Diagnosis and planning)
**Next Session:** TBD (Validation or next priority)
