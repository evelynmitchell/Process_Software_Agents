# Session Summary - 2025-12-03 Session 1

## Objective
Add OpenTelemetry tracing instrumentation to API and Web UI calls for reinforcement learning integration.

---

## Context

The goal is to add comprehensive OpenTelemetry tracing that captures (state, action, reward) triplets to support reinforcement learning systems like Agent Lightning. This instrumentation will enable:
- Observability of all API calls and web UI interactions
- Data collection for RL training on system usage patterns
- Performance monitoring and optimization

---

## Prior Day Summary (December 2nd - 11 Sessions)

| Session | Focus | Key Outcome |
|---------|-------|-------------|
| 1 | Test coverage | 73%â†’78%, ADR 002 |
| 2 | PR merges | Merged 3 PRs, started web UI integration |
| 3 | Pre-commit | Added linting hooks |
| 4 | E2E tests | 24/24 passing, telemetry DB |
| 5-7 | Web UI | HITL, costs, sparklines, budget, traceability, dark mode, diff view |
| 8-9 | Bug fixes | Unicode fix, CI/CD lint fixes |
| 10 | Features | What-If simulator, +40 tests |
| 11 | Docs | README update (partial) |

**Current State:**
- Test coverage: 74%
- Web UI: 12/13 tasks complete
- All CI/CD pipelines passing

---

## OpenTelemetry Tracing Plan

### Target Areas for Instrumentation

1. **API Layer** (`src/asp/web/api.py`)
   - All database queries
   - External service calls
   - Data aggregation functions

2. **Web UI Routes**
   - `manager.py` - Manager dashboard endpoints
   - `developer.py` - Developer dashboard endpoints
   - `product.py` - Product manager endpoints
   - `main.py` - Core routes and health checks

3. **Data Layer** (`src/asp/web/data.py`)
   - Telemetry DB operations
   - Artifact file operations
   - Budget/settings persistence

4. **Orchestrators** (`src/asp/orchestrators/`)
   - TSP orchestration loops
   - Agent execution traces

### RL Triplet Structure (State, Action, Reward)

For Agent Lightning integration:
- **State**: Current system context (active agents, pending tasks, resource utilization)
- **Action**: User/agent operation being performed (API call, UI navigation, task execution)
- **Reward**: Outcome metrics (latency, success/failure, cost, tokens used)

---

## Completed Work

### 1. Reviewed Existing Telemetry Infrastructure

Discovered existing instrumentation:
- **Langfuse**: Already integrated for LLM observability (spans, events, usage)
- **SQLite** (`asp_telemetry.db`): Persistent storage with `agent_cost_vector` and `defect_log` tables
- **Decorators**: `@track_agent_cost` and `@log_defect` in `src/asp/telemetry/telemetry.py`

### 2. Documented Available State Information

Identified all data sources for RL state capture:
- Request context (task_id, description, requirements)
- Agent context (role, version, prompts)
- Pipeline context (phase, iteration, prior artifacts)
- System context (budget, approvals, active agents)
- Trace context (trace_id, parent_span, call depth)

### 3. Created ADR 003: OpenTelemetry RL Triplet Instrumentation

**File:** `design/ADR_003_opentelemetry_rl_triplet_instrumentation.md`

Key decisions:
- Use OpenTelemetry SDK with custom `rl.state.*`, `rl.action.*`, `rl.reward.*` attributes
- Complement (not replace) existing Langfuse integration
- Export via OTLP to Agent Lightning
- Decorator-based instrumentation (`@rl_triplet`)

Defined schemas for:
- **RLState**: 25 fields capturing decision context
- **RLAction**: 18 fields capturing function results
- **RLReward**: 9 fields for immediate and delayed rewards

---

## Files Created/Modified

| File | Change |
|------|--------|
| `design/ADR_003_opentelemetry_rl_triplet_instrumentation.md` | New ADR document |
| `Summary/summary20251203.1.md` | Session summary |

---

## Next Steps (Implementation Plan from ADR)

### Phase 1: Foundation
- [ ] Add OpenTelemetry dependencies to pyproject.toml
- [ ] Create `src/asp/telemetry/otel.py` configuration
- [ ] Create `src/asp/telemetry/rl_schemas.py` dataclasses
- [ ] Create `src/asp/telemetry/rl_triplet.py` decorator

### Phase 2: Agent Instrumentation
- [ ] Add `@rl_triplet` to all 7 agents

### Phase 3: Web UI Instrumentation
- [ ] Auto-instrument FastAPI routes
- [ ] Add custom spans for key interactions

### Phase 4: Delayed Rewards
- [ ] HITL approval callback
- [ ] Test result callback
- [ ] Defect penalty

### Phase 5: Agent Lightning Integration
- [ ] Configure OTLP exporter
- [ ] Validate format compatibility

---

## Open Questions for User

1. **Agent Lightning Format**: What exact schema does Agent Lightning expect for triplets?
2. **Prompt Capture**: Full text vs hash only?
3. **Reward Timing**: Immediate only vs delayed rewards?
4. **Sampling**: 100% capture or sampled?

---

## Technical Notes

- OpenTelemetry Python SDK: `opentelemetry-api`, `opentelemetry-sdk`
- OTLP exporter for Agent Lightning integration
- Auto-instrumentation available for FastAPI/Starlette
- Complements existing Langfuse (separate concerns)

---

## Status
Complete - ADR created, awaiting review and approval before implementation
